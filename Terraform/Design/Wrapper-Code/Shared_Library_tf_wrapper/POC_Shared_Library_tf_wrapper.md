# Implementation of CD Checks on Terraform Module wrapper code

|   Author        |  Created on   |  Version   | Last updated by  | Last edited on |
| --------------- | --------------| -----------|----------------- | -------------- |
| Khushi Malhotra |  18 March 2024  |  Version 1 | Khushi Malhotra  | 18 March 2024    |

![image](https://github.com/avengers-p7/Documentation/assets/156056460/44f80ab7-909e-48c2-8b1e-ea004054137e)

## Table of Contents
- [Introduction](#Introduction)
- [Pre-requisites](#Pre-requisites)
- [Implementation of CD checks on Terraform Module Wrapper Code](#Implementation-of-CD-checks-on-Terraform-Module-Wrapper-Code)
- [Terraform Module](#Terraform-Module)
- [Jenkinsfile](#Jenkinsfile)
- [Terraform groovy template file](#Terraform-groovy-template-file)
- [Shared Library src files](#Shared-library-src-files)
- [Output](#Output)
- [Contact Information](#Contact-Information)
- [References](#References)

## Introduction
Integrating Continuous Deployment (CD) practices into Continuous Integration/Continuous Deployment (CI/CD) pipelines for Terraform modules involves automating the deployment of infrastructure configurations.
Automated Deployment: CD in CI/CD pipelines automates the deployment of Terraform modules, ensuring that changes are applied consistently and efficiently across different environments.

## Pre-requisites

| Tool |
|------|
| Terraform |

## Implementation of CD checks on Terraform Module Wrapper Code

![image](https://github.com/CodeOps-Hub/Documentation/assets/156056460/c56d7ed0-7db0-49ce-aeb8-d35f53a0f993)


| Tool             | Purpose                                                                                                                                                                  |
|------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| terraform plan  | The `terraform plan` command is used to create an execution plan for changes to your infrastructure. It compares the current state of your infrastructure, as defined by your Terraform configuration files, with the desired state specified in those files. It then generates an execution plan that describes what Terraform will do to achieve the desired state, including which resources will be created, modified, or destroyed. However, `terraform plan` does not make any actual changes to your infrastructure; it only previews the changes that Terraform would make. This allows you to review the proposed changes before applying them to your infrastructure. |
| terraform apply | The `terraform apply` command is used to apply the changes described in the Terraform execution plan generated by `terraform plan` to your infrastructure. When you run `terraform apply`, Terraform reads the execution plan and performs the necessary actions to create, modify, or destroy resources as needed to achieve the desired state specified in your Terraform configuration files. This command actually makes changes to your infrastructure, so it sh

**Step-1** Create a New Pipeline Job

- Navigate to the Jenkins dashboard and click on New Item.
- Enter a name for your job (e.g., "Terraform.CD").
- Select Pipeline and click OK.

**Step-2** Configure Pipeline Script

- In the job configuration page, scroll down to the Pipeline section.
- Select Pipeline script from SCM.
- Give required repo url and enter your credentials.

**Step-3** Save the Configuration

- Click on Save to save the job configuration.

**Step-4** Build the Pipeline

- Once the pipeline configuration is saved, you can manually trigger the build by clicking on Build Now.

**Step-5** View Build Console Output

- After triggering the build, you can view the progress and console output of the build by clicking on the build number in the Jenkins dashboard.
- The console output will display the steps executed by the pipeline script, including code checkout and compilation.
- Verify Successful Compilation.

![image](https://github.com/CodeOps-Hub/Documentation/assets/156056460/2c54d83e-f452-4d09-8a48-ea6d0f450bcf)

![image](https://github.com/CodeOps-Hub/Documentation/assets/156056460/8a40dcc0-275e-404c-bdb5-c8487d829d89)

![image](https://github.com/CodeOps-Hub/Documentation/assets/156056460/4e2ee4c3-d2ad-4442-b9c8-482051653eb0)

<details>
<summary> <b> Click here for Console Output </b> </summary>
<br>
  
  ```shell 
Started by user Shikha Tripathi
Obtained SharedLibrary/Terraform_CD_JF/Jenkinsfile from git https://github.com/CodeOps-Hub/Jenkinsfile.git
Loading library snaatak-p7@main
Attempting to resolve main from remote references...
 > git --version # timeout=10
 > git --version # 'git version 2.34.1'
using GIT_ASKPASS to set credentials Khushi_PAT
 > git ls-remote -h -- https://github.com/CodeOps-Hub/SharedLibrary.git # timeout=10
Found match: refs/heads/main revision 206b5107ced1c26a3135bfacf5b3cc3f6442a235
WARNING: ignoring request to compute changelog in clone mode
The recommended git tool is: NONE
using credential Khushi_PAT
Cloning the remote Git repository
Cloning with configured refspecs honoured and without tags
Cloning repository https://github.com/CodeOps-Hub/SharedLibrary.git
 > git init /var/lib/jenkins/jobs/wrapper_code_execution/builds/24/libs/0b1d56fb27dae0ade66d5763d8e6b212a8fb941adabaab4c9ece1bd48fc7ec99 # timeout=10
Fetching upstream changes from https://github.com/CodeOps-Hub/SharedLibrary.git
 > git --version # timeout=10
 > git --version # 'git version 2.34.1'
using GIT_ASKPASS to set credentials Khushi_PAT
 > git fetch --no-tags --force --progress -- https://github.com/CodeOps-Hub/SharedLibrary.git +refs/heads/*:refs/remotes/origin/* # timeout=10
 > git config remote.origin.url https://github.com/CodeOps-Hub/SharedLibrary.git # timeout=10
 > git config --add remote.origin.fetch +refs/heads/*:refs/remotes/origin/* # timeout=10
Avoid second fetch
Checking out Revision 206b5107ced1c26a3135bfacf5b3cc3f6442a235 (main)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f 206b5107ced1c26a3135bfacf5b3cc3f6442a235 # timeout=10
Commit message: "Update terraform_CD.groovy"
[Pipeline] Start of Pipeline
[Pipeline] node
Running on Jenkins in /var/lib/jenkins/jobs/wrapper_code_execution/workspace
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Declarative: Checkout SCM)
[Pipeline] checkout
Selected Git installation does not exist. Using Default
The recommended git tool is: NONE
using credential Khushi_PAT
 > git rev-parse --resolve-git-dir /var/lib/jenkins/jobs/wrapper_code_execution/workspace/.git # timeout=10
Fetching changes from the remote Git repository
 > git config remote.origin.url https://github.com/CodeOps-Hub/Jenkinsfile.git # timeout=10
Fetching upstream changes from https://github.com/CodeOps-Hub/Jenkinsfile.git
 > git --version # timeout=10
 > git --version # 'git version 2.34.1'
using GIT_ASKPASS to set credentials Khushi_PAT
 > git fetch --tags --force --progress -- https://github.com/CodeOps-Hub/Jenkinsfile.git +refs/heads/*:refs/remotes/origin/* # timeout=10
 > git rev-parse refs/remotes/origin/main^{commit} # timeout=10
Checking out Revision 63bf114811b8f0508f566fda0e3fb8e3d4594d44 (refs/remotes/origin/main)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f 63bf114811b8f0508f566fda0e3fb8e3d4594d44 # timeout=10
Commit message: "Update Jenkinsfile"
 > git rev-list --no-walk 2f8460f0f64483749291a4adee9a8ea513fb847c # timeout=10
[Pipeline] }
[Pipeline] // stage
[Pipeline] withEnv
[Pipeline] {
[Pipeline] withCredentials
WARNING: Unknown parameter(s) found for class type 'com.cloudbees.jenkins.plugins.awscredentials.AmazonWebServicesCredentialsBinding': keyIdVariable,secretVariable
WARNING: Unknown parameter(s) found for class type 'com.cloudbees.jenkins.plugins.awscredentials.AmazonWebServicesCredentialsBinding': keyIdVariable,secretVariable
Masking supported pattern matches of $AWS_ACCESS_KEY_ID or $AWS_SECRET_ACCESS_KEY
[Pipeline] {
[Pipeline] withEnv
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Terraform)
[Pipeline] script
[Pipeline] {
[Pipeline] properties
[Pipeline] stage
[Pipeline] { (Clone)
[Pipeline] script
[Pipeline] {
[Pipeline] git
The recommended git tool is: NONE
using credential Khushi_PAT
 > git rev-parse --resolve-git-dir /var/lib/jenkins/jobs/wrapper_code_execution/workspace/.git # timeout=10
Fetching changes from the remote Git repository
 > git config remote.origin.url https://github.com/CodeOps-Hub/Terraform-modules.git # timeout=10
Fetching upstream changes from https://github.com/CodeOps-Hub/Terraform-modules.git
 > git --version # timeout=10
 > git --version # 'git version 2.34.1'
using GIT_ASKPASS to set credentials Khushi_PAT
 > git fetch --tags --force --progress -- https://github.com/CodeOps-Hub/Terraform-modules.git +refs/heads/*:refs/remotes/origin/* # timeout=10
 > git rev-parse refs/remotes/origin/main^{commit} # timeout=10
Checking out Revision 6a43c43a5f0cc526928eaf8d7912af86275b2fab (refs/remotes/origin/main)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f 6a43c43a5f0cc526928eaf8d7912af86275b2fab # timeout=10
 > git branch -a -v --no-abbrev # timeout=10
 > git branch -D main # timeout=10
 > git checkout -b main 6a43c43a5f0cc526928eaf8d7912af86275b2fab # timeout=10
Commit message: "Update main.tf"
 > git rev-list --no-walk 6a43c43a5f0cc526928eaf8d7912af86275b2fab # timeout=10
[Pipeline] }
[Pipeline] // script
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Terraform action)
[Pipeline] script
[Pipeline] {
[Pipeline] sh
+ cd wrapperCode/Frontend_Wrapper_Code/Dev_Env
[Pipeline] }
[Pipeline] // script
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Terraform init)
[Pipeline] script
[Pipeline] {
[Pipeline] sh
+ cd wrapperCode/Frontend_Wrapper_Code/Dev_Env
+ terraform init

[0m[1mInitializing the backend...[0m
[0m[1mInitializing modules...[0m

[0m[1mInitializing provider plugins...[0m
- Reusing previous version of hashicorp/tls from the dependency lock file
- Reusing previous version of hashicorp/aws from the dependency lock file
- Reusing previous version of hashicorp/local from the dependency lock file
- Using previously-installed hashicorp/tls v4.0.5
- Using previously-installed hashicorp/aws v5.41.0
- Using previously-installed hashicorp/local v2.5.1

[0m[1m[32mTerraform has been successfully initialized![0m[32m[0m
[0m[32m
You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.[0m
[Pipeline] }
[Pipeline] // script
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Terraform Plan)
[Pipeline] script
[Pipeline] {
[Pipeline] sh
+ cd wrapperCode/Frontend_Wrapper_Code/Dev_Env
+ terraform plan
[0m[1mmodule.Dev_Frontend.tls_private_key.private_key: Refreshing state... [id=0386914e08d10646edc09f966ed5be1b839745d7][0m
[0m[1mmodule.Dev_Frontend.local_file.private_key: Refreshing state... [id=bd4a0a9d111ff0b4e25673b777ca727b72f66652][0m
[0m[1mmodule.Dev_Frontend.aws_key_pair.key_pair: Refreshing state... [id=Dev_Frontend_Key][0m
[0m[1mmodule.Dev_Frontend.aws_lb_target_group.Target_group: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:133673781875:targetgroup/Dev-Frontend-TG/0232b25fc4609db3][0m
[0m[1mmodule.Dev_Frontend.aws_security_group.security_group: Refreshing state... [id=sg-0d8bd79deeabf2448][0m
[0m[1mmodule.Dev_Frontend.aws_launch_template.Template: Refreshing state... [id=lt-016d6beee2e03d86b][0m
[0m[1mmodule.Dev_Frontend.aws_lb_listener_rule.path_rule: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:133673781875:listener-rule/app/Dev-ALB/75bc9b1a35dbe964/761653fb399a30be/9c7e5be35a6432fc][0m
[0m[1mmodule.Dev_Frontend.aws_autoscaling_group.ASG: Refreshing state... [id=Dev-Frontend_ASG][0m
[0m[1mmodule.Dev_Frontend.aws_autoscaling_policy.ASG_Policy: Refreshing state... [id=target-tracking-policy][0m

[0m[1m[32mNo changes.[0m[1m Your infrastructure matches the configuration.[0m

[0mTerraform has compared your real infrastructure against your configuration
and found no differences, so no changes are needed.
[Pipeline] }
[Pipeline] // script
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Approval For Apply)
[Pipeline] script
[Pipeline] {
[Pipeline] input
Do you want to apply Terraform changes?
Proceed or Abort
Approved by Shikha Tripathi
[Pipeline] }
[Pipeline] // script
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Terraform Apply)
[Pipeline] script
[Pipeline] {
[Pipeline] sh
+ cd wrapperCode/Frontend_Wrapper_Code/Dev_Env
+ terraform apply -auto-approve
[0m[1mmodule.Dev_Frontend.tls_private_key.private_key: Refreshing state... [id=0386914e08d10646edc09f966ed5be1b839745d7][0m
[0m[1mmodule.Dev_Frontend.local_file.private_key: Refreshing state... [id=bd4a0a9d111ff0b4e25673b777ca727b72f66652][0m
[0m[1mmodule.Dev_Frontend.aws_key_pair.key_pair: Refreshing state... [id=Dev_Frontend_Key][0m
[0m[1mmodule.Dev_Frontend.aws_lb_target_group.Target_group: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:133673781875:targetgroup/Dev-Frontend-TG/0232b25fc4609db3][0m
[0m[1mmodule.Dev_Frontend.aws_security_group.security_group: Refreshing state... [id=sg-0d8bd79deeabf2448][0m
[0m[1mmodule.Dev_Frontend.aws_launch_template.Template: Refreshing state... [id=lt-016d6beee2e03d86b][0m
[0m[1mmodule.Dev_Frontend.aws_lb_listener_rule.path_rule: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:133673781875:listener-rule/app/Dev-ALB/75bc9b1a35dbe964/761653fb399a30be/9c7e5be35a6432fc][0m
[0m[1mmodule.Dev_Frontend.aws_autoscaling_group.ASG: Refreshing state... [id=Dev-Frontend_ASG][0m
[0m[1mmodule.Dev_Frontend.aws_autoscaling_policy.ASG_Policy: Refreshing state... [id=target-tracking-policy][0m

[0m[1m[32mNo changes.[0m[1m Your infrastructure matches the configuration.[0m

[0mTerraform has compared your real infrastructure against your configuration
and found no differences, so no changes are needed.
[0m[1m[32m
Apply complete! Resources: 0 added, 0 changed, 0 destroyed.
[0m[0m[1m[32m
Outputs:

[0mAutoscaling_group_id = [
  [
    "Dev-Frontend_ASG",
  ],
]
Autoscaling_policy_name = [
  [
    "target-tracking-policy",
  ],
]
Security_Group_ID = [
  [
    "sg-0d8bd79deeabf2448",
  ],
]
Target_group_id = [
  [
    "arn:aws:elasticloadbalancing:ap-northeast-1:133673781875:targetgroup/Dev-Frontend-TG/0232b25fc4609db3",
  ],
]
key_pair_name = [
  [
    "Dev_Frontend_Key",
  ],
]
launch_template_id = [
  [
    "lt-016d6beee2e03d86b",
  ],
]
[Pipeline] }
[Pipeline] // script
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Approval For Apply)
[Pipeline] script
[Pipeline] {
[Pipeline] echo
Skipping Terraform destroy since action is not set to 'destroy'
[Pipeline] }
[Pipeline] // script
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Pem Key Archive)
[Pipeline] script
[Pipeline] {
[Pipeline] archiveArtifacts
Archiving artifacts
[Pipeline] }
[Pipeline] // script
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // script
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // withEnv
[Pipeline] }
[Pipeline] // withCredentials
[Pipeline] }
[Pipeline] // withEnv
[Pipeline] }
[Pipeline] // node
[Pipeline] End of Pipeline
Finished: SUCCESS
```
</details>

## [Terraform Module](https://github.com/CodeOps-Hub/Terraform-modules/tree/main/wrapperCode/Frontend_Wrapper_Code/QA_Env)

## [Jenkinsfile](https://github.com/CodeOps-Hub/Jenkinsfile/blob/khushi/networkSkeleton_QA/SharedLibrary/Terraform_CD_JF/Jenkinsfile)

```shell
@Library('snaatak-p7') _

def terraformCD = new org.avengers.template.terraformCD.terraform_CD()

properties([
    parameters([
        string(name: 'branch', defaultValue: 'main', description: 'Enter the branch name'),
        string(name: 'rootPath', defaultValue: 'wrapperCode', description: 'Enter the root directory path'),
        string(name: 'childPath', defaultValue: 'Frontend_Wrapper_Code/Dev_Env', description: 'Enter the child directory path')
    ])
])

node {
    def url = 'https://github.com/CodeOps-Hub/Terraform-modules.git'
    def creds = 'Khushi_PAT'

    withEnv(['AWS_ACCESS_KEY_ID=shikha_cred', 'AWS_SECRET_ACCESS_KEY=shikha_cred', 'TF_CLI_ARGS=-input=false']) {
        stage('Terraform') {
            terraformCD.call(url, creds, params.branch, params.rootPath, params.childPath, params.ACTION)
        }
    }
}
```
## [Terraform groovy template file](https://github.com/CodeOps-Hub/SharedLibrary/blob/main/src/org/avengers/template/terraformCD/terraform_CD.groovy)

<details>
  <summary> <b>Click here to see the terraform_CD.groovy file</b>b </summary>
<br>

  ```shell
package org.avengers.template.terraformCD

import org.avengers.common.*
import org.avengers.terraform_CICD.*

def call(String url, String creds, String branch, String rootPath, String childPath, String ACTION){

    variablization = new action()
    gitCheckoutPrivate = new GitCheckoutPrivate()
    initialization = new init()
    deploying = new deploy()
    destroy = new destroy()
    keyarchive = new keyarchive()
    
  

    gitCheckoutPrivate.call(url, creds, branch)
    variablization.call(rootPath, childPath)
    initialization.call(rootPath, childPath)
    deploying.call(rootPath, childPath, ACTION)
    destroy.call(rootPath, childPath, ACTION)
    keyarchive.call(rootPath, childPath)

}
```
</details>

## [Shared Library src files](https://github.com/CodeOps-Hub/SharedLibrary/tree/main/src/org/avengers/terraform_CICD)
<details>
<summary> <b>Click here to see src files</b> </summary>
<br>

  ```shell
  
deploy.groovy

package org.avengers.terraform_CICD

def call(String rootPath, String childPath, String ACTION) {
    stage("Terraform Plan") {
        script {
            sh "cd ${rootPath}/${childPath} && terraform plan"
        }
    }

    if (ACTION == 'apply') {
        stage('Approval For Apply') {
            script {
                // Prompt for approval before applying changes
                input "Do you want to apply Terraform changes?"
            }
        }
        stage('Terraform Apply') {
            script {
                // Run Terraform apply
                sh 'cd ${rootPath}/${childPath} && terraform apply -auto-approve'
            }
        }
    } else {
        echo "Skipping Terraform apply since action is not set to 'apply'"
    }
}

```

keyarchiving.groovy

```shell
package org.avengers.terraform_CICD

def call(String rootPath, String childPath) {
    stage("Pem Key Archive") {
        script {
            archiveArtifacts artifacts: "${rootPath}/${childPath}/*.pem", allowEmptyArchive: true
        }
    }
}
```
</details>

## Output

1. Security group
   ![image](https://github.com/CodeOps-Hub/Documentation/assets/156056460/c92b5c62-9fac-4e3f-85b6-d54a642d56a1)
***

2. Auto Scalling Group
   ![image](https://github.com/CodeOps-Hub/Documentation/assets/156056460/f4f3b3aa-76d5-41a4-b942-0b065e6086c3)
***

3. ALB Listener
   ![image](https://github.com/CodeOps-Hub/Documentation/assets/156056460/93b72769-c78b-4468-bf72-65102f073bc4)
***

4. Key pair
  ![image](https://github.com/CodeOps-Hub/Documentation/assets/156056460/f8103f2f-6005-4ff2-ad1e-47440e1caf04)
***

5. Target Group
  ![image](https://github.com/CodeOps-Hub/Documentation/assets/156056460/417e44cf-ff00-4da9-9ac8-623f8ebfa466)
***

## Contact Information
| Name            | Email Address                        |
|-----------------|--------------------------------------|
| Khushi Malhotra | khushi.malhotra.snaatak@mygurukulam.co |

## References

| Description                                   | References  
| --------------------------------------------  | -------------------------------------------------|
| Terraform Module | https://spacelift.io/blog/what-are-terraform-modules-and-how-do-they-work |
| What is CD | https://www.atlassian.com/continuous-delivery/principles/continuous-integration-vs-delivery-vs-deployment |
| Terraform Module CI/CD | https://www.reddit.com/r/Terraform/comments/17ldr9i/cicd_for_creating_terraform_modules/ |
